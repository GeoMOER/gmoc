---
title: "DM-WS-11-01"
author: "MOC - Data Analysis (T. Nauss, C. Reudenbach)"
date: "20. Oktober 2016"
output: html_document
---

Read and write
```{r}
# Set path ---------------------------------------------------------------------
if(Sys.info()["sysname"] == "Windows"){
  filepath_base <- "D:/active/moc/msc-phygeo-data-analysis/"
} else {
  filepath_base <- "/media/permanent/active/moc/msc-phygeo-data-analysis/"
}

path_data <- paste0(filepath_base, "data/")
path_dwd <- paste0(path_data, "dwd/3164_coelbe/")
path_noaa <- paste0(path_data, "noaa/")
path_csv <- paste0(path_data, "csv/")
path_rdata <- paste0(path_data, "rdata/")
path_temp <- paste0(filepath_base, "temp/")


# Load libraries ---------------------------------------------------------------


# Read csv file and clean data frame -------------------------------------------
pr <- read.table(paste0(path_dwd, "produkt_monat_Monatswerte_19460101_20141231_03164.txt"), 
                 header = TRUE, sep = ";", dec = ".")

nao <- read.table(paste0(path_noaa, "nao_norm_1950-2000.txt.txt"),
                  header = TRUE, sep = "", dec = ".")

pr$DATUM <- substr(pr$MESS_DATUM_BEGINN, 1, 6)
nao$DATUM <- paste0(nao$YEAR, sprintf("%02d", nao$MONTH))

df <- merge(pr, nao)
df <- df[, c(which(colnames(df) == "DATUM"),
             which(colnames(df) == "LUFTTEMPERATUR"),
             which(colnames(df) == "NIEDERSCHLAGSHOEHE"),
             which(colnames(df) == "INDEX"))]
df <- df[1:which(df$DATUM == "199012"), ]
df$ts <- seq(1950, 1990+11/12, length = nrow(df))

df$NIEDERSCHLAGSHOEHE[df$NIEDERSCHLAGSHOEHE < 0] <- NA
plot(df$ts, df$NIEDERSCHLAGSHOEHE, col = "blue", type = "h")
lines(df$ts, df$INDEX * 10)

monthly_mean <- aggregate(df$NIEDERSCHLAGSHOEHE, 
                          by = list(substr(df$DATUM, 5, 6)), 
                          FUN = mean, na.rm = TRUE)
df$ND_DS <- df$NIEDERSCHLAGSHOEHE - monthly_mean$x
df$ND_SQRT <- sqrt(df$NIEDERSCHLAGSHOEHE)

df$NAO_CL <- "P"
df$NAO_CL[df$INDEX < 0] <- "N"
df$NAO_CL <- as.factor(df$NAO_CL)

monthly_mean_nao <- aggregate(df$NIEDERSCHLAGSHOEHE, 
                              by = list(paste0(df$NAO_CL, substr(df$DATUM, 5, 6))), 
                              FUN = mean, na.rm = TRUE)
monthly_mean_nao
plot(seq(12), monthly_mean_nao$x[1:12], type = "l", col = "blue")
points(seq(12), monthly_mean_nao$x[13:24], type = "l", col = "red")

lmod <- lm(df$ND_SQRT ~ sin(2*pi*df$ts) + cos(2*pi*df$ts) + df$NAO_CL)
summary(lmod)

mod_bs <- lapply(seq(2000), function(x){
  # Jetzt sampeln, dann rechnen
  set.seed <- x
  boot <- sample(nrow(df), replace = FALSE) 
  NAO_CL <- as.factor(df$NAO_CL[boot])
  act_mod <- lm(df$ND_SQRT ~ sin(2*pi*df$ts) + cos(2*pi*df$ts) + NAO_CL)
  return(act_mod$coefficients)
})
mod_bs <- as.data.frame(do.call("rbind", mod_bs))
summary(mod_bs)

lmod$coefficients[4] <= quantile(mod_bs$NAO_CLP, probs = 0.025)




monthly_mean_nao <- aggregate(df$LUFTTEMPERATUR, 
                              by = list(paste0(df$NAO_CL, substr(df$DATUM, 5, 6))), 
                              FUN = mean, na.rm = TRUE)
monthly_mean_nao
plot(seq(12), monthly_mean_nao$x[1:12], type = "l", col = "blue")
points(seq(12), monthly_mean_nao$x[13:24], type = "l", col = "red")


lmod <- lm(df$LUFTTEMPERATUR ~ sin(2*pi*df$ts) + cos(2*pi*df$ts) + df$NAO_CL)
summary(lmod)


plot(df$ts, df$LUFTTEMPERATUR, type = "l")
lines(df$ts, lmod$fitted.values, col = "red")

mod_bs <- lapply(seq(2000), function(x){
  # Jetzt sampeln, dann rechnen
  set.seed <- x
  boot <- sample(nrow(df), replace = FALSE) 
  NAO_CL <- as.factor(df$NAO_CL[boot])
  act_mod <- lm(df$LUFTTEMPERATUR ~ sin(2*pi*df$ts) + cos(2*pi*df$ts) + NAO_CL)
  summary(act_mod)
  return(act_mod$coefficients)
})
mod_bs <- as.data.frame(do.call("rbind", mod_bs))
summary(mod_bs)

lmod$coefficients[4] >= quantile(mod_bs$NAO_CLP, probs = 0.975)
```
